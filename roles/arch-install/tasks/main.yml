---
- block:
    - import_role:
        name: mount

    - name: Pacstrap
      command: pacstrap /mnt {{ item.pkg }}
      args:
        creates: /mnt{{ item.file }}
      loop:
        - { pkg: base, file: /usr/bin/bash }
        - { pkg: base-devel, file: /usr/bin/sudo }
        - { pkg: python, file: /usr/bin/python }

    - name: Generate fstab
      lineinfile:
        path: /mnt/etc/fstab
        line: '{{ item }}'
      loop: '{{ q("lines", "genfstab -U /mnt") }}'

  rescue:
    - import_role:
        name: unmount
